@model ClassificadorDoc.Controllers.RelatorioPreviewModel
@{
    ViewData["Title"] = "Visualizar Relatório";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-eye"></i> Visualizar Relatório</h3>
                <div>
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt"></i> @Model.TipoRelatorio
                    </h5>
                    <small>Período: @Model.DataInicio.ToString("dd/MM/yyyy") a @Model.DataFim.ToString("dd/MM/yyyy")</small>
                    @if (!string.IsNullOrEmpty(Model.Categoria))
                    {
                        <small class="ms-3">Categoria: @Model.Categoria</small>
                    }
                    @if (!string.IsNullOrEmpty(Model.Status))
                    {
                        <small class="ms-3">Status: @Model.Status</small>
                    }
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ReportId))
                    {
                        <!-- FastReport WebReport Iframe -->
                        <div class="report-container">
                            <iframe 
                                src="@Url.Action("WebReport", new { id = Model.ReportId })" 
                                width="100%" 
                                height="800px" 
                                style="border: 1px solid #ddd; border-radius: 0.375rem;">
                                <p>Seu navegador não suporta iframes. 
                                   <a href="@Url.Action("WebReport", new { id = Model.ReportId })" target="_blank">
                                       Clique aqui para abrir o relatório em uma nova janela
                                   </a>
                                </p>
                            </iframe>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <a href="@Url.Action("WebReport", new { id = Model.ReportId })" 
                               target="_blank"
                               class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> Abrir em Nova Janela
                            </a>
                            <a href="@Url.Action("Gerar", new { 
                                   tipoRelatorio = Model.TipoRelatorio.ToLower().Replace("relatório de ", "").Replace("relatório ", ""),
                                   dataInicio = Model.DataInicio.ToString("yyyy-MM-dd"),
                                   dataFim = Model.DataFim.ToString("yyyy-MM-dd"),
                                   categoria = Model.Categoria,
                                   status = Model.Status,
                                   formato = "pdf"
                               })"
                               class="btn btn-success">
                                <i class="fas fa-download"></i> Baixar PDF
                            </a>
                        </div>
                    }
                    else if (Model.PdfBytes != null && Model.PdfBytes.Length > 0)
                    {
                        <!-- Fallback: PDF inline se não houver WebReport -->
                        <div class="pdf-container" style="height: 800px; border: 1px solid #ddd;">
                            <iframe 
                                src="data:application/pdf;base64,@Model.PdfBase64" 
                                width="100%" 
                                height="100%" 
                                style="border: none;">
                                <p>Seu navegador não suporta a visualização de PDF inline. 
                                   <a href="data:application/pdf;base64,@Model.PdfBase64" download="relatorio_@(Model.TipoRelatorio.ToLower())_@(Model.DataInicio.ToString("yyyyMMdd")).pdf">
                                       Clique aqui para baixar o PDF
                                   </a>
                                </p>
                            </iframe>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <a href="data:application/pdf;base64,@Model.PdfBase64" 
                               download="relatorio_@(Model.TipoRelatorio.ToLower())_@(Model.DataInicio.ToString("yyyyMMdd")).pdf"
                               class="btn btn-success">
                                <i class="fas fa-download"></i> Baixar PDF
                            </a>
                        </div>
                    }
                    else if (Model.Dados != null && Model.Dados.Rows.Count > 0)
                    {
                        <!-- Fallback: Tabela HTML se não houver PDF -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        @foreach (System.Data.DataColumn column in Model.Dados.Columns)
                                        {
                                            <th>@column.ColumnName</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (System.Data.DataRow row in Model.Dados.Rows)
                                    {
                                        <tr>
                                            @foreach (var item in row.ItemArray)
                                            {
                                                <td>
                                                    @if (item != null)
                                                    {
                                                        @if (item is DateTime dateTime)
                                                        {
                                                            @dateTime.ToString("dd/MM/yyyy HH:mm")
                                                        }
                                                        else if (item is decimal || item is double || item is float)
                                                        {
                                                            @string.Format("{0:N2}", item)
                                                        }
                                                        else
                                                        {
                                                            @item.ToString()
                                                        }
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <p class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Total de registros: @Model.Dados.Rows.Count
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhum registro encontrado</h5>
                            <p class="text-muted">Não há dados para o período e filtros selecionados.</p>
                        </div>
                    }

                    <!-- Rodapé do Relatório -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> Gerado em: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> Sistema ClassificadorDoc
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @@media print {
        .btn, .d-flex {
            display: none !important;
        }
        .card {
            border: none !important;
            box-shadow: none !important;
        }
    }
</style>
